## 1. Тема и целевая аудитория

### Тема

TikTok - сервис для создания и просмотра коротких видео

### Целевая аудитория

* TikTok насчитывает 1,66 миллиарда ежемесячных активных пользователей по всему миру. [[2](#использованные-источники)]
* На сегодняшний день TikTok скачали более 4,92 миллиарда раз. [[1](#использованные-источники)]
* Страны с наибольшим количеством пользователей TikTok. [[1](#использованные-источники)]

| Страна               | Количество пользователей TikTok |
|----------------------|---------------------------------|
| Соединенные Штаты    | 148.92 миллиона                 |
| Индонезия            | 127,5 миллиона                  |
| Бразилия             | 101 миллион                     |
| Мексика              | 74,15 миллиона                  |
| Вьетнам              | 67,72 миллиона                  |
| Российская Федерация | 58,59 миллиона                  |
| Пакистан             | 54,38 миллиона                  |
| Филиппины            | 49,09 миллиона                  |
| Таиланд              | 44,38 миллиона                  |
| Турция               | 37,73 миллиона                  |
| Бангладеш            | 37,36 миллиона                  |
| Саудовская Аравия    | 35,1 миллиона                   |
| Египет               | 32,94 миллиона                  |

### Ключевой функционал

* Регистрация и авторизация
* Просмотр видео в ленте
* Подписки на других пользователей
* Добавление в друзья
* Чат
* Отправка/получение видео
* Комментирование видео
* Публикация видео
* Реакции
* Добавить видео в избранное

### Ключевые продуктовые решения

* Дополнительные реакции смайликами
* Рекомендации, основанные на местоположении пользователя (видео людей, находящихся поблизости в городе или районе)
* История просмотров

## 2. Расчет нагрузки

### Основные данные для расчета нагрузки

* MAU - 1,66 млрд. пользователей [[2](#использованные-источники)]
* DAU - 600 млрд. пользователей [[2](#использованные-источники)]
* С ноября 2021 по январь 2022 года в TikTok регистрировалось более 650 тысяч новых пользователей каждый день (это почти
  8 новых аккаунтов в секунду).[[7]()]
* Среднее время пользования приложением за день 58 мин. [[3](#использованные-источники)]
* В день пользователи выкладывают 34 млн. видео [[5](#использованные-источники)]
* Средний размер 15 сек. видео 4мб. [[4](#использованные-источники)]
* Максимальный размер видео 287.6 МБайт [[6](#использованные-источники)]
* Коэффициент соотношения пикового трафика к среднему k=1.65

### Публикация видео

#### Продуктовые метрики

Средний месячный размер хранилища пользователя равен:
4 МБ * (34 млн видео в день / 600 млн пользователей) * 30 дней = 6.8 МБ.

Следовательно, средний размер хранилища пользователя(за 5 лет):
6.8МБ * 12 месяцев * 5 лет = 408 МБ (0.39 ГБ)

Среднее количество действий пользователя в день:
34 млн видео в день / 600 млн пользователей = 0.06 видео в день

#### Технические метрики

Пользователь в среднем выкладывает 0.06 видео в день.
Следовательно, среднее количество запросов в секунду равно:
0.06 * 600000000 / (24 * 60 * 60) = 416 RPS

Размер хранения публикаций видео:
0.39 ГБ * 600000000 / 1024 / 1024 = 228515 Тб (223 Пб)

Максимальный размер видео в TikTok составляет 287,6 мегабайта. Пиковое потребление данных приходится на одни сутки.
Поскольку пользователи из разных часовых поясов смотрят видео в разное время, средний трафик равномерно распределяется в
течение суток. Поэтому коэффициент, на который нужно умножить средний трафик, чтобы получить пиковый, можно взять равным
1,65:
(287.6 * 8 / 1000 / 1000) Тбит * 34 млн/д / (24 * 60 * 60) * 1.65 = 1.4939 Тбит/с

Суммарный суточный трафик:
34 млн/д * 4 МБ / 1024 = 132812 Гб/д (129,7 Тб/д)

### Просмотр ленты

#### Продуктовые метрики

Средний размер хранилища пользователя:
довольно незначительный: хранить идентификаторы пользователя и просмотренные им видео, поэтому можно не учитывать.

Средний размер видео 15 секунд, следовательно, при том что среднее время в приложении в день 58 минут, пользователь в
среднем смотрит:
60 / 15 * 58 = 232 действий/день

#### Технические метрики

Размер хранения не учитываем из-за незначительных данных.

Пользователь в среднем смотрит 284 видео в день, среднее количество запросов в секунду равно:
345 * 600000000 / (24 * 60 * 60) = 2395833 RPS

За 5 минут постоянно листая в среднем получается 150 МБ на все запросы для просмотра ленты.
Пиковое потребление в течение суток. Трафик по часам распределяется равномерно, потому что пользователи из разных
часовых поясов, поэтому средний трафик от пикового не отличается, поэтому возьмем небольшой коэфицент k=1.65, на который
умножим этот средний трафик, и получим пиковый:
((((150 МБ / (5 * 60) секунд) Мб/с * 8 / 1000 / 1000) Тбит/с * (90 * 60)c) Тбит * 600 млн/д) Тбит/д / (24 * 60 * 60)
Тбит/с * 1.65 = 247.5 Тбит/с

Суммарный суточный трафик:
((150 МБ / (5 * 60)) МБ/с / 1024 Гб/c * (90 * 60 c/д)) Гб/д * 600млн = 1582031250 Гб/день (1508 Пб/день)

### Регистрация

С ноября 2021 по январь 2022 года в TikTok регистрировалось более 650 тысяч новых пользователей каждый день,
следовательно:
650000 / 24 / 60 / 60 = 7.52 регистраций/секунду

### Авторизация

Предположим, что авторизуются пользователи в 10 раз чаще, чем регистрируются, поэтому имеем:
7.52 * 10 = 75.2 авторизаций/секунду

### Реакции/комментарии

Мы ранее получили, что пользователь в среднем смотрит 284 видео в день. При том, что пользователь в среднем лайкает
каждое 10 видео и комментирует каждое 50ое, получаем в среднем на пользователя:
284 / 20 = 14,2 лайков/день на пользователя
284 / 70 = 4,05 комментария/день на пользователя

Теперь посчитаем RPS и RPD для лайков и комментариев:
18 * 600000000 = 8 520 000 000 лайков/день
8 520 000 000 / 24 / 60 / 60 = 98611 лайков/секунду

4,05 * 600 000 000 = 2 430 000 000 комментариев/день
2 430 000 000 / 24 / 60 / 60 = 28125 комментариев/секунду

### Итоговые таблицы

#### Продуктовые метрики:

| Действие         | Средний размер хранилища пользователя (ГБайт) | Среднее количество действий пользователя в день |
|------------------|-----------------------------------------------|-------------------------------------------------| 
| Публикация видео | 0.39                                          | 0.05                                            |
| Просмотр ленты   | Незначителен                                  | 284                                             |

#### Технические метрики

| Действие         | Размер хранения (Тб) | Пиковое потребление в течении суток (Тбит/с) | Суммарный суточный трафик (Гбайт/д) |
|------------------|----------------------|----------------------------------------------|-------------------------------------|
| Публикация видео | 228515               | 1.4939                                       | 132812 Гбайт/д                      | 
| Просмотр ленты   | Незначителен         | 247.5                                        | 1582031250                          |

#### RPS

| Действие         | RPS     |
|------------------|---------| 
| Публикация видео | 416     |
| Просмотр ленты   | 2395833 |
| Регистрация      | 7.52    |
| Авторизация      | 75.2    |
| Реакции          | 98611   |
| Комментарии      | 28125   |

## 3. Глобальная балансировка нагрузки

### Географическое расположение дата-центров

![img.png](https://i.imgur.com/cOflQWC.png)

На основе данных из раздела «Распределение аудитории по странам» можно сделать вывод, что наиболее значительная часть
пользователей TikTok проживает в Северной и Южной Америке (США, Мексика, Бразилия) и Индонезии.

В Европе аудитория TikTok распределена относительно равномерно. Особенность азиатского рынка заключается в том, что
TikTok заблокирован в Индии, а в Китае используется его локальная версия — Douyin, которая в этом обзоре не
рассматривается.

Учитывая эти данные, целесообразно расположить дата-центры в крупных городах США, равномерно распределив их по стране:

* Нью-Йорк
* Лос-Анджелес
* Даллас

Следующей по числу пользователей является Индонезия, поэтому там также следует разместить несколько дата-центров:

* Джакарта
* Медан

В Бразилии, где также велика аудитория TikTok, разместим дата-центры в ключевых городах:

* Бразилиа
* Сан-Паулу

Несмотря на близость Мексики к США, разумно установить дата-центр и там, так как количество пользователей TikTok в
Мексике довольно велико:

* Мехико

Россия также входит в число стран с большим числом пользователей, поэтому добавим дата-центр:

* Москва

Для Европы предложим следующее размещение дата-центров в крупнейших городах:

* Лондон (обеспечивает покрытие большей части Европы)
* Анкара (охватывает как часть Европы, так и страны Ближнего Востока)

В Азии, чтобы обеспечить максимальный охват, разместим дата-центры в удалённых друг от друга крупных городах:

* Ханой
* Токио

Для покрытия небольшой аудитории в Африке целесообразно разместить дата-центр в одном из крупных городов, расположенном
ближе к центру континента:

* Лагос

### Алгоритм работы с использованием Latency-based DNS и BGP Anycast

#### **Запрос DNS:**

* Когда пользователь запрашивает контент, происходит DNS-запрос.
* DNS-сервер использует **Latency-based алгоритм**, чтобы на основе задержки (RTT) выбрать ближайший к пользователю
  дата-центр или регион. Это определяет подсеть, к которой пользователь будет подключен.
* DNS возвращает IP-адрес подсети, к которой относится ближайший по задержке дата-центр.

#### **BGP Anycast:**

* После получения IP-адреса из DNS, пользователь начинает передавать трафик на этот IP.
* С помощью **BGP Anycast** несколько дата-центров (например, находящиеся в одной стране или регионе) могут использовать
  один и тот же IP-адрес.
* Маршрутизация на уровне BGP направляет пользователя в ближайший дата-центр (в пределах выбранной подсети) на основе
  сетевой топологии и текущей нагрузки.

## 4. Локальная балансировка нагрузки

#### **L3 балансировка (Layer 3):**

* На сетевом уровне используем **Virtual Server via Direct Routing** (VS/DR), который обеспечивает быструю маршрутизацию
  пакетов к L7 балансировщикам.
* **Direct Routing** позволяет L3 балансировщику перенаправлять пакеты на конечные сервера без изменений. Позволит
  сохранять оригинальный IP-контекст и снизить задержку при обработке запросов.
* **Keepalived** будет использоваться для мониторинга состояния нод и перенаправления трафика в случае отказа одного из
  балансировщиков.

#### **L7 балансировка (Layer 7):**

* На прикладном уровне балансировки запросы будут распределяться через **Nginx**, который выступит в роли
  прокси-сервера.
* **Nginx** будет выступать в роли прокси-сервера и распределять запросы от клиентов между несколькими
  серверами-бэкендами для обеспечения равномерной нагрузки и улучшения производительности серверов.

### Отказоустойчивость

#### **L3 отказоустойчивость:**

* **Keepalived** будет управлять состоянием L3 балансировщиков и переключать трафик в случае падения одного из узлов.
* При этом будет использован механизм **VRRP** (Virtual Router Redundancy Protocol), чтобы поддерживать активный и
  резервный балансировщики на уровне сети.

#### **L7 отказоустойчивость:**

* **Nginx** будет выполнять мониторинг состояния серверов-бэкендов и динамически исключать вышедшие из строя сервера из
  пула доступных.
* В случае отказа бэкенда запросы будут перенаправляться на доступные ноды.

### Нагрузка по терминации SSL

На современных серверах SSL рукопожатие может занимать от 2 мс при сокращённом рукопожатии до 20 мс при
полном[[8](#использованные-источники)], при этом это время включает полный ответ. В то время как сами вычисления на
процессоре занимают около 0.5–0.6 мс. Для последующих расчётов примем, что SSL рукопожатие занимает 3 мс, так как будем
использовать сокращённые рукопожатия в Nginx. Т.е сервер и клиент будут согласны на переиспользование защищённой сессии,
которую использовали ранее (session tickets)

Исходя из пикового RPS по всем основным запросам (4,161,412.73 RPS), можно рассчитать, что на обработку SSL за одну
секунду потребуется:
4,161,412.73 * 3 мс = 12,484,238.19 мс = 12,484.24 секунд вычислительного времени.

## 5. Логическая схема БД

![Логическая схема](https://github.com/user-attachments/assets/c72fc68f-1da4-452f-998d-ac9cfe25926c)

## 6. Физическая схема БД

![Физическая схема](https://github.com/user-attachments/assets/140f18f4-1c10-49c1-a41b-7095dc812652)

### Основные решения

| Технология |                                                                                   Область применения                                                                                   |
|:-----------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| Выбор СУБД | 	PostgreSQL – для основных продуктовых сущностей, статистика для подбора видео, Redis - для хранения сессий, ClickHouse для хранения просмотров и лайков, Amazon S3 для хранения видео |
| Индексы    |                                 user.username, comment.video_id, subscribe.target_user_id, view.video_id, video_like.video_id, comment_like.comment_id                                 |
| Шардинг    |                                   view по video_id, video_like по video_id, comment_like по comment_id, comment по video_id, остальные таблицы по id                                   |

### Индексы

## Индексы

### Таблица `user`

| Поле                | Тип индекса | Примечания                                                    |
|---------------------|-------------|---------------------------------------------------------------|
| `username`, `email` | Хеш-индекс  | Для быстрой проверки наличия username или email в базе данных |

### Таблица `comment`

| Поле       | Тип индекса | Примечания                                     |
|------------|-------------|------------------------------------------------|
| `video_id` | Хеш-индекс  | Для быстрого поиска комментариев по `video_id` |

### Таблица `video_like`

| Поле       | Тип индекса | Примечания                                            |
|------------|-------------|-------------------------------------------------------|
| `video_id` | Primary key | Для эффективной агрегации количества лайков для видео |
| `user_id`  | Skip индекс | Для фильтрации по активности пользователя             |

### Таблица `video_view`

| Поле        | Тип индекса | Примечания                                           |
|-------------|-------------|------------------------------------------------------|
| `video_id`  | Primary key | Для ускоренной агрегации по просмотрам видео         |
| `user_id`   | Skip индекс | Для выборки всех просмотров конкретного пользователя |
| `view_date` | Skip индекс | Для фильтрации по времени просмотров                 |

### Таблица `comment_like`

| Поле         | Тип индекса | Примечания                                  |
|--------------|-------------|---------------------------------------------|
| `comment_id` | Primary key | Для подсчета количества лайков комментариев |
| `user_id`    | Skip индекс | Для выборки всех лайков пользователя        |

### Таблица `video_counters`

| Поле       | Тип индекса | Примечания                                   |
|------------|-------------|----------------------------------------------|
| `video_id` | Primary key | Для ускоренной выборки агрегированных данных |

### Таблица `comment_counters`

| Поле         | Тип индекса | Примечания                       |
|--------------|-------------|----------------------------------|
| `comment_id` | Primary key | Для подсчета лайков комментариев |

### Таблица `video_meta`

| Поле       | Тип индекса | Примечания                              |
|------------|-------------|-----------------------------------------|
| `video_id` | Primary key | Для ускоренной выборки метаданных видео |
| `topics`   | GIN индекс  | Для быстрого поиска по темам видео      |

### Таблица `user_video_actions`

| Поле                  | Тип индекса        | Примечания                                     |
|-----------------------|--------------------|------------------------------------------------|
| `user_id`             | Индекс             | Для ускоренной выборки действий пользователя   |
| `video_id`            | Индекс             | Для ускоренной выборки по видео                |
| `user_id`, `video_id` | Композитный индекс | Для ускоренной выборки по пользователю и видео |
| `events_happened`     | GIN индекс         | Для поиска по типам событий с видео            |

### Таблица `subscription`

| Поле                                | Тип индекса        | Примечания                                 |
|-------------------------------------|--------------------|--------------------------------------------|
| `subscriber_id`, `subscribed_to_id` | Композитный индекс | Для быстрого поиска по нескольким столбцам |

### Шардирование и резервирование СУБД. Схема резервного копирования.

Выберем ключ разбиения на шарды крупных таблиц. Таблицу view будем шардировать по video_id, video_like по video_id,
comment_like по comment_id,
comment по video_id, остальные таблицы по id.

В целях резервного копирования на каждом из дата-центров установим одну вторичную базу данных. В случае сбоя основной
базы, эта вторичная база принимает на себя роль основной, управляя данными пользователей. Резервные данные регулярно
экспортируются на внешний накопитель.

### Таблица `user`

| Название поля       | Тип данных | Размер (байты) |
|---------------------|------------|----------------|
| id                  | uuid       | 16             |
| username            | varchar    | 16             |
| email               | varchar    | 16             |
| password            | bytes      | 16             |
| description         | varchar    | 256            |
| **Итого за запись** |            | **320**        |

### Таблица `video`

| Название поля       | Тип данных | Размер (байты) | 
|---------------------|------------|----------------|
| id                  | uuid       | 16             |
| author_id           | uuid       | 16             |
| url                 | varchar    | 16             |
| description         | varchar    | 256            |
| video_length        | integer    | 4              |
| release_date        | timestamp  | 8              |
| **Итого за запись** |            | **316**        |

### Таблица `comment`

| Название поля       | Тип данных | Размер (байты) |
|---------------------|------------|----------------|
| id                  | uuid       | 16             |
| video_id            | uuid       | 16             |
| author_id           | uuid       | 16             |
| parent_id           | uuid       | 16             |
| release_date        | timestamp  | 8              |
| text                | varchar    | 256            |
| **Итого за запись** |            | **328**        |

### Таблица `subscribe`

| Название поля       | Тип данных | Размер (байты) |
|---------------------|------------|----------------|
| subscriber_id       | uuid       | 16             |
| subscribed_to_id    | uuid       | 16             |
| **Итого за запись** |            | **32**         |

### Таблица`view`

| Название поля       | Тип данных | Размер (байты) |
|---------------------|------------|----------------|
| id                  | uuid       | 16             |
| video_id            | uuid       | 16             |
| user_id             | uuid       | 16             |
| **Итого за запись** |            | **48**         |

### Таблица `video_like`

| Название поля       | Тип данных | Размер (байты) |
|---------------------|------------|----------------|
| id                  | uuid       | 16             |
| video_id            | uuid       | 16             |
| user_id             | uuid       | 16             |
| **Итого за запись** |            | **48**         |

### Таблица `video_counters`

| Название поля       | Тип данных | Размер (байты) |
|---------------------|------------|----------------|
| id                  | uuid       | 16             |
| video_id            | uuid       | 16             |
| views_count         | integer    | 4              |
| likes_count         | integer    | 4              |
| **Итого за запись** |            | **40**         |

### Таблица `comment_like`

| Название поля       | Тип данных | Размер (байты) |
|---------------------|------------|----------------|
| id                  | uuid       | 16             |
| comment_id          | uuid       | 16             |
| user_id             | uuid       | 16             |
| **Итого за запись** |            | **48**         |

### Таблица `comment_counters`

| Название поля       | Тип данных | Размер (байты) |
|---------------------|------------|----------------|
| id                  | uuid       | 16             |
| comment_id          | uuid       | 16             |
| likes_count         | integer    | 4              |
| **Итого за запись** |            | **36**         |

### Таблица `user_session`

| Название поля       | Тип данных | Размер (байты) |
|---------------------|------------|----------------|
| token               | varchar    | 256            |
| user_id             | uuid       | 16             |
| created_at          | timestamp  | 8              |
| updated_at          | timestamp  | 8              |
| expires_at          | timestamp  | 8              |
| **Итого за запись** |            | **296**        |

### Таблица `video_meta`

| Название поля       | Тип данных | Размер (байты) |
|---------------------|------------|----------------|
| id                  | uuid       | 16             |
| video_id            | uuid       | 16             |
| topics              | text[]     | -              |
| **Итого за запись** |            | **от 32**      |

### Таблица `user_video_actions`

| Название поля       | Тип данных | Размер (байты) |
|---------------------|------------|----------------|
| id                  | uuid       | 16             |
| user_id             | uuid       | 16             |
| video_id            | uuid       | 16             |
| watch_percent       | integer    | 4              |
| events_happened     | text[]     | -              |
| **Итого за запись** |            | **от 52**      |

## 7. Алгоритмы

### Формирование рекомендаций

### 1. Сбор данных

Алгоритм собирает данные о действиях пользователя при просмотре видео, включая следующие параметры:

- `user_id` — идентификатор пользователя.
- `video_id` — идентификатор видео.
- `watch_percent` — процент просмотра видео, что помогает оценить заинтересованность.
- `events_happened` — перечень событий, произошедших во время просмотра (лайк, комментарий, сохранение и т.д.).

Помимо данных взаимодействий, для анализа предпочтений пользователя также используются метаданные видео, такие как
`topics`, которые позволяют учесть тематику видео.

### 2. Запись данных

Собранные данные отправляются в брокер сообщений Kafka для асинхронной передачи и последующей обработки в системе
рекомендаций. Данные сохраняются в базах данных в зависимости от типа события (`EventType`):

- Например, при лайке обновляется `likes_count`, при добавлении комментария — `comments_count`.

Эти показатели популярности актуализируются в базе данных и используются для анализа популярности видео.

### 3. Генерация рекомендаций (модель SVD)

Для предсказания интересов пользователя применяется модель SVD (Singular Value Decomposition):

1. **Разложение матрицы** — SVD разлагает матрицу взаимодействий пользователей и видео, выявляя скрытые предпочтения.
2. **Предсказание интереса** — на основе скрытых факторов модель предсказывает, какие видео могут заинтересовать
   пользователя.
3. **Формирование списка рекомендаций** — на основе предсказанных интересов создается список видео, которые
   пользователь, вероятно, захочет посмотреть.

После генерации рекомендации сохраняются для каждого пользователя, чтобы они были доступны при последующем входе на
платформу.

### 4. Ранжирование рекомендаций

Для улучшения точности и релевантности рекомендаций алгоритм ранжирует видео в ленте пользователя, учитывая:

- **Индивидуальные предпочтения** — видео с высоким `watch_percent` и частыми лайками от пользователя получают более
  высокий приоритет.
- **Популярность видео** — видео с большим числом просмотров и лайков получает приоритет.
- **Тематика** — предпочтительные `topics` пользователя повышают приоритет видео с аналогичной тематикой.
- **Свежесть контента** — для привлечения внимания к новым видео при прочих равных показываются недавно добавленные
  видео.

### Поиск видео

### 1. Индексирование видео

Индексирование каждого видео начинается сразу после загрузки и включает следующие этапы:

Текстовые атрибуты:

- **Текстовые атрибуты**:
    - `video_id`: уникальный идентификатор видео.
    - `title`: заголовок видео.
    - `description`: текстовое описание видео.
    - `topics`: темы или категории, к которым относится видео (например, "спорт", "музыка").

1. Визуальные теги (`visual_tags`):
   С помощью алгоритмов глубокого обучения (например, CNN — Convolutional Neural Networks) выделяются сцены и объекты в
   видеороликах.
   На основе анализа изображений видео классифицируется по категориям (например, "природа", "еда", "спорт"), добавляются
   теги для каждого ключевого кадра или сцены, такие как "танец", "пейзаж" или "еда".
   Этот подход позволяет находить видео на основе визуального содержания, даже если у него нет текстовых меток или
   описания.

2. Тип действия (`action_type`):
   Для анализа движений и действий используется техника распознавания действий на основе видеофреймов (например, с
   использованием рекуррентных нейронных сетей, LSTM или CNN-LSTM).
   Из видеоряда выделяются ключевые действия, которые происходят в видео, такие как "бег", "танец", "вождение". Это
   позволяет пользователю искать видео, вводя действия, без необходимости в текстовом описании.
   Такие алгоритмы помогают в распознавании и классификации действий даже в коротких видеороликах.

3. Жанр аудио или настроение (`audio_mood`):
   Для извлечения характеристик звука используется анализ частотных спектров и машинное обучение для определения жанра
   или настроения аудиодорожки (например, с применением MFCC - Mel-Frequency Cepstral Coefficients).
   Алгоритмы классифицируют музыкальный фон или звуковые эффекты, что позволяет определить настроение видео: энергичное,
   спокойное, эмоциональное и т.п.
   Такие аудиофичи помогают находить видео по музыке или настроению, даже если содержание визуально не выражено в
   тексте.

4. **Объекты (`objects`)**:
   Алгоритмы объектного распознавания (например, YOLO или Faster R-CNN) идентифицируют конкретные объекты в кадре, такие
   как "машина", "собака", "горы".
   На основе этого анализа видео дополнительно индексируется, что помогает точно идентифицировать объекты в сценах для
   более детализированного поиска.

### 2. Запросы на поиск

Запросы в ElasticSearch поддерживают поиск как по текстовым, так и по метаданным:

- **Поиск по темам**: Находит видео, совпадающее с полем `topics`, а также с `title` и `description`.
- **Поиск по визуальным тэгам и действиям**: Позволяет искать по `visual_tags` и `action_type`, например, "бег", "еда".
- **Поиск по аудиожанру или настроению**: Фильтрация по `audio_mood`, например, "спокойная музыка".
- **Фильтрация по количественным метрикам**: Фильтрация по `likes_count` и `views_count` позволяет выделить популярные
  видео.
- **Агрегация**: Агрегация по популярным темам или количеству просмотров помогает анализировать тренды.

### 3. Оптимизация поиска и ранжирование

Ранжирование результатов происходит на основе:

- **Релевантности запроса**: Ранжирование по точности совпадения.
- **Популярности**: Приоритет на основе `likes_count` и `views_count`.
- **Свежести**: Новые видео получают больший приоритет.
- **Интересов пользователя**: История взаимодействий пользователя также влияет на ранжирование.

## 8. Технологии

| Технология                             | Область применения                                                 | Мотивация                                                                                                                                                                                                                                                                |
|----------------------------------------|--------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Golang**                             | Бэкенд, серверная часть                                            | Статически типизируемый, компилируемый язык, высокая производительность и скорость разработки                                                                                                                                                                            |
| **Python**                             | ML                                                                 | Язык программирования для выполнения задач машинного обучения                                                                                                                                                                                                            |
| **React**                              | Фронтенд, проектирование интерфейсов                               | Компонентный подход, удобство создания UI, наличие Virtual DOM                                                                                                                                                                                                           |
| **Kotlin**                             | Фронтенд (Android)                                                 | Современный язык для разработки Android-приложений                                                                                                                                                                                                                       |
| **Swift**                              | Фронтенд (iOS)                                                     | Современный язык для разработки iOS-приложений                                                                                                                                                                                                                           |
| **gRPC**                               | Взаимодействие микросервисов, SQLite-сервер                        | Увеличение скорости передачи данных между сервисами (в 7-10 раз), популярность                                                                                                                                                                                           |
| **TypeScript**                         | Фронтенд                                                           | Статическая типизация, популярность                                                                                                                                                                                                                                      |
| **PostgreSQL**                         | Хранение основных данных                                           | Современная реляционная СУБД                                                                                                                                                                                                                                             |
| **Redis**                              | Кэш для авторизационных токенов                                    | Хранение данных в оперативной памяти для быстрого доступа                                                                                                                                                                                                                |
| **ClickHouse**                         | Хранение данных для частых и объемных агрегатов (просмотры, лайки) | Быстрая колоночная БД                                                                                                                                                                                                                                                    |
| **Amazon S3**                          | Хранение статического контента (видео)                             | Стандарт облачного хранения, оптимален для видео                                                                                                                                                                                                                         |
| **ElasticSearch**	                     | Поиск по страницам                                                 | 	Достаточно большая скорость индексирования и поиска, шардирование и репликация из коробки, гибкий функционал настроек индекса.                                                                                                                                          |
| **Kubernetes**                         | Деплой и масштабирование                                           | Масштабирование, отказоустойчивость, утилизация ресурсов                                                                                                                                                                                                                 |
| **Kafka**                              | Брокер сообщений                                                   | Подходит для обработки больших потоков данных                                                                                                                                                                                                                            |
| **Apache Spark**                       | Обработка и анализ данных                                          | Подходит для обработки больших объемов данных и создания моделей машинного обучения                                                                                                                                                                                      |
| **SVD (Singular Value Decomposition)** | Алгоритм рекомендаций                                              | Используется для матричной факторизации при генерации персонализированных рекомендаций                                                                                                                                                                                   |
| **Vault**                              | Хранилище секретов                                                 | Средство для безопасного хранения и управления доступом к конфиденциальной информации, такой как пароли и API-ключи, предотвращает несанкционированный доступ и улучшает безопасность системы.                                                                           |
| **TensorFlow/PyTorch**                 | Обучение моделей машинного обучения                                | Используется для создания и обучения сложных моделей, включая модели рекомендаций                                                                                                                                                                                        |
| **Hadoop**                             | Хранение и обработка больших объемов данных для обучения моделей   | Поддерживает распределенное хранение данных и параллельную обработку, что важно для работы с большими данными в ML                                                                                                                                                       |
| **Airflow**                            | Управление задачами ETL и ML-пайплайнами                           | Оркестрация ETL-процессов и циклов обучения ML-моделей                                                                                                                                                                                                                   |
| **Fluentd**                            | Сбор и маршрутизация логов                                         | Гибкость в интеграции с различными системами хранения логов, поддержка множества плагинов для удобного сбора и обработки данных                                                                                                                                          |
| **Nginx**                              | Балансировка L7, терминация SSL                                    | Простая настройка, высокая производительность, масштабируемость и кеширование                                                                                                                                                                                            |
| **Keepalived**	                        | Балансировка нагрузки уровня L3	                                   | Обеспечивает отказоустойчивость и позволяет распределять трафик по серверам внутри ЦОД. Поддерживает VRRP, что позволяет перенаправлять трафик при отказе узлов, повышая отказоустойчивость системы.                                                                     |
| **GitLab**                             | Система контроля версий, CI/CD                                     | Распространенная система контроля версий и автоматизации процессов разработки                                                                                                                                                                                            |
| **Prometheus**                         | Сбор метрик                                                        | Система мониторинга и оповещений, оптимизированная для сбора и хранения временных рядов данных. Позволяет получать и хранить информацию о состоянии системы и сервисов, настроена на отслеживание показателей производительности и состояния в режиме реального времени. |
| **Grafana**                            | Визуализация метрик, мониторинг                                    | Визуализирует метрики из различных источников (например, Prometheus) в виде графиков и дашбордов, что помогает инженерам следить за состоянием системы, выявлять проблемы и отслеживать показатели производительности.                                                   |

## 9. Схема проекта

![project](https://github.com/user-attachments/assets/7f4850f4-bc5e-4834-bf6a-b49cca50ce0a)

## 10. Обеспечение надежности

### Логирование

Используем Distributed Tracing System.
Этот подход позволяет отслеживать цепочку запросов через различные сервисы и компоненты системы,
это упростит выявление узких мест и источников задержек.
Tracing помогает видеть полный путь запроса, включая его время выполнения на каждом этапе,
и обеспечивает целостную картину взаимодействий между сервисами.

Для этого нужно будет использовать паттерн request id:

* Присваиваем ID запросу от пользователя (не используем автоинкремент)
* Передаем его во всех запросах ко всем бэкендам
* Во всех сервисах сохраняем ID и время его обработки в лог

### Мониторинг

Сбор метрик, отображаемых в Grafana, и отправка алертов, помогают своевременно выявить проблемные места в коде,
например долгое выполнение определенных запросов поможет заострить внимание на анализе пути запроса и ускорении запроса.
Мониторинг, логирование с помощью Prometheus

### QA

CI/CD, качественное тестирование, code review.

### Резервирование ресурсов

Резервируем сервера, датацентры, CPU, диски, память
Вероятность отказа для одного диска составляет примерно 0,0001, и при наличии 10,000 дисков всегда будет некоторое
количество отказавших.

### Резервирование баз данных и брокера сообщений

В Postgres, Redis используем механизм репликации master-slave, а также периодическое резервное копирование данных.
В ClickHouse используем репликацию с помощью ReplicatedMergeTree.

У Kafka будем использовать соглашение exactly once. Это значит, что если приложение-продюсер из-за сбоя сети или
какой-то внутренней ошибки
повторно отправит одни и те же данные в Kafka, сообщение будет записано в топиках только один раз.

### Graceful shutdown

Необходимо реализовать “плавную” остановку (сервер не получает новые запросы, ожидает закрытия всех
активных соединений, чтобы завершить свою работу).

### Graceful degradation

Необходима проработка архитектуры, которая учитывает отказ компонентов и продолжает
стабильно работать некоторое или неограниченное количество времени. Функции с наибольшим трафиком находятся в
приоритете, скорее всего
при отказе компонентов не получится поддержать функциональность на 100%.

Для TikTok критичной функциональностью будет авторизация, загрузка видео, просмотр ленты.

Примеры:

- Если упал сервис рекомендаций, идем в сервис Videos_meta и ранжируем видео только по данным из ClickHouse
  (просмотры, лайки).
- Если упал ClickHouse, не отображаем просмотры, лайки.

### Failover policy

- перезапросы
- меньше запросов, которые посылаются на проблемный хост, компонент
- Circuit Breaker. Реализуем с помощью Nginx. Лимитируем трафик к сервисам, на основании отслеживаемого количества
  возвращаемых ошибок.

## 11. Расчет ресурсов

| Действие                | Сервисы                                      | RPS     | Требуемое количество ядер | Требуемое количество RAM |
|-------------------------|----------------------------------------------|---------|---------------------------|--------------------------|
| Публикация видео        | Videos_content, Videos_meta                  | 434     | 5                         | 1 Гб                     |
| Просмотр ленты          | Recommendations, Videos_content, Videos_meta | 3125000 | 31250                     | 3125 Гб                  |
| Авторизация/регистрация | Authorization, Users_content                 | 1069    | 10                        | 22 Гб                    |
| Лайки                   | Videos_meta, Users_actions                   | 156250  | 1562                      | 160 Гб                   |
| Комментарии             | Comments, Users_actions                      | 44618   | 446                       | 45 Гб                    |
| Поиск                   | search                                       | 61724   | 617                       | 620ГБ                    |
| Подписки/отписки        | subscribes                                   | 1241    | 12                        | 24ГБ                     |



| Сервер     | Процессор                    | Ядра | Оперативная память | Долговременная память       | Приблизительная стоимость за единицу | Амортизация на 5 лет | Цена аренды | Сетевая карта | Количество | 
|------------|------------------------------|------|--------------------|-----------------------------|--------------------------------------|----------------------|-------------|---------------|------------|
| PostgreSQL | 2 x Intel Xeon Gold 6248R    | 64   | 1 ТБ DDR4 ECC      | 8 x 2 ТБ NVMe SSD в RAID 10 | $20,000                              | 250 $/мес.           | 650 $/мес.  | 25 GbE        | 500        |
| ClickHouse | 2 x Intel Xeon Platinum 8280 | 28   | 768 ГБ DDR4 ECC    | 8 x 4 ТБ NVMe SSD в RAID 10 | $20,000                              | 330 $/мес.           | 650 $/мес.  | 25 GbE        | 500        |
| Redis      | 2 x Intel Xeon Gold 6248R    | 28   | 256 ГБ DDR4 ECC    | 2 x 1 ТБ NVMe SSD в RAID 1  | $10,000                              | 170 $/мес.           | 350 $/мес.  | 10 GbE        | 100        |
| Kubenode   | 2 x AMD EPYC 7742            | 64   | 1 ТБ DDR4 ECC      | 4 x 1 ТБ NVMe SSD в RAID 10 | $20,000                              | 330 $/мес.           | 650 $/мес.  | 25 GbE        | 600        |

### Берем в аренду

## Суммарные затраты

### 1. **Собственные серверы (амортизация на 5 лет)**

- PostgreSQL: $250/мес. * 500 = **$125,000/мес.**
- ClickHouse: $330/мес. * 500 = **$165,000/мес.**
- Redis: $170/мес. * 100 = **$17,000/мес.**
- Kubenode: $330/мес. * 600 = **$198,000/мес.**

Общие затраты на серверы: **$505,000/мес.**

Дополнительно учтём расходы на Amazon S3 для хранения данных (4350 ТБ):  
$23/ТБ * 4350 ТБ = **$100,050/мес.**

**Итого: $505,000 + $100,050 = $770,050/мес.**

### 2. **Аренда серверов**

- PostgreSQL: $650/мес. * 500 = **$325,000/мес.**
- ClickHouse: $650/мес. * 500 = **$325,000/мес.**
- Redis: $350/мес. * 100 = **$35,000/мес.**
- Kubenode: $650/мес. * 600 = **$390,000/мес.**

**Итого: $325,000 + $325,000 + $35,000 + $390,000 = $1,075,000/мес.**

## Сравнение затрат

| Тип инфраструктуры      | Затраты в месяц |
|-------------------------|-----------------|
| **Собственные серверы** | **$770,050**    |
| **Аренда серверов**     | **$1,075,000**  |

### **Вывод**
Собственные серверы обходятся дешевле аренды на **$304,950/мес.** при расчёте амортизации на 5 лет.

### Использованные источники

1. [How Many People Use TikTok (2024 Statistics) By Shubham Singh / August 20, 2024](https://www.demandsage.com/tiktok-user-statistics/)
2. [TikTok Revenue and Usage Statistics (2024)](https://www.businessofapps.com/data/tik-tok-statistics/)
3. [Average Time Spent on TikTok Statistics (2024)](https://explodingtopics.com/blog/time-spent-on-tiktok)
4. [How Much Data Does TikTok Use & How to Reduce it?](https://blog.talkhome.co.uk/technology/how-much-data-does-tiktok-use/https://blog.talkhome.co.uk/technology/how-much-data-does-tiktok-use/)
5. [How Many Video Are Uploaded to TikTok Per Day?](https://techjury.net/blog/how-many-videos-are-uploaded-to-tiktok-daily/)
6. [Ideal TikTok Vide Size: Ultimate Guide To TikTok Video Sizes (2024)](https://www.shopify.com/au/blog/tiktok-video-size)
7. [Сколько пользователей в TikTok? (сентябрь 2024)](https://inclient.ru/tiktok-stats/)
8. [SSL handshake overhead](https://www.ibm.com/docs/en/cics-ts/6.x?topic=performance-ssl-handshake-overhead)
